
/**
 * CreativeFlow Robust Engine v11 - AUTO INIT VERSION
 * Role: Expert Google Apps Script Developer
 */

const FOLDER_NAME = "CreativeFlow_Assets";

// Definisi Struktur Database
const SCHEMA = {
  'Content': ['id', 'postdate', 'deadline', 'platform', 'title', 'caption', 'drivelink', 'status', 'assignee', 'notes'],
  'Evidence': ['id', 'activitytitle', 'category', 'description', 'pdfurl', 'ambassadorname', 'date', 'status'],
  'Minutes': ['id', 'date', 'title', 'summary', 'filelink', 'author'],
  'Attendance': ['id', 'name', 'timestamp', 'photo', 'lat', 'lng', 'type'],
  'Schedules': ['id', 'ambassadornames', 'tasktitle', 'description', 'date', 'category', 'priority', 'location'],
  'Performance': ['id', 'month', 'views', 'likes', 'shares', 'comments']
};

/**
 * AUTO-INIT: Memastikan semua sheet dan header tersedia
 */
function checkAndInitSheets() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  Object.keys(SCHEMA).forEach(tabName => {
    let sheet = ss.getSheetByName(tabName);
    if (!sheet) {
      sheet = ss.insertSheet(tabName);
      sheet.appendRow(SCHEMA[tabName]);
      // Format Header: Bold & Freeze
      sheet.getRange(1, 1, 1, SCHEMA[tabName].length).setFontWeight("bold").setBackground("#f3f3f3");
      sheet.setFrozenRows(1);
    }
  });
}

/**
 * READ: doGet(e)
 */
function doGet(e) {
  try {
    checkAndInitSheets(); // Jalankan auto-init
    const tabName = e.parameter.tab || 'Content';
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName(tabName);
    
    const data = sheet.getDataRange().getValues();
    if (data.length <= 1) return createResponse([]);
    
    const rawHeaders = data[0];
    const normalizedHeaders = rawHeaders.map(h => h.toString().toLowerCase().trim().replace(/\s+/g, ''));
    
    const result = data.slice(1).map(row => {
      let obj = {};
      normalizedHeaders.forEach((header, index) => {
        let val = row[index];
        if (val instanceof Date) {
          val = Utilities.formatDate(val, ss.getSpreadsheetTimeZone(), "yyyy-MM-dd");
        }
        obj[header] = val;
      });
      return obj;
    });
    
    return createResponse(result);
  } catch (err) {
    return createResponse({success: false, message: err.toString()}, 500);
  }
}

/**
 * WRITE: doPost(e)
 */
function doPost(e) {
  try {
    checkAndInitSheets(); // Jalankan auto-init
    const payload = JSON.parse(e.postData.contents);
    const tabName = payload.tab;
    const action = payload.action;
    let itemData = payload.data;

    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName(tabName);

    const rawHeaders = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
    const normalizedHeaders = rawHeaders.map(h => h.toString().toLowerCase().trim().replace(/\s+/g, ''));
    const idColumnIndex = normalizedHeaders.indexOf('id');

    // 1. CRITICAL: Handle Files (Base64 to Drive)
    if (action !== 'delete') {
      itemData = handleFiles(itemData, tabName);
    }

    // 2. Find Row Index by ID
    let rowIndex = -1;
    if (itemData.id) {
      const allValues = sheet.getDataRange().getValues();
      for (let i = 1; i < allValues.length; i++) {
        if (allValues[i][idColumnIndex].toString() === itemData.id.toString()) {
          rowIndex = i + 1;
          break;
        }
      }
    }

    // 3. Action Logic
    if (action === 'delete' && rowIndex !== -1) {
      sheet.deleteRow(rowIndex);
      return createResponse({success: true, message: 'Deleted from Spreadsheet'});
    }

    if (action === 'update' && rowIndex !== -1) {
      rawHeaders.forEach((rawHeader, idx) => {
        const key = rawHeader.toString().toLowerCase().trim().replace(/\s+/g, '');
        if (itemData[key] !== undefined) {
          sheet.getRange(rowIndex, idx + 1).setValue(itemData[key]);
        }
      });
      return createResponse({success: true, message: 'Updated with Drive URLs'});
    }

    if (action === 'create') {
      const newRow = rawHeaders.map(rawHeader => {
        const key = rawHeader.toString().toLowerCase().trim().replace(/\s+/g, '');
        return itemData[key] !== undefined ? itemData[key] : "";
      });
      sheet.appendRow(newRow);
      return createResponse({success: true, message: 'Created with Drive URLs'});
    }

    return createResponse({success: false, message: 'Invalid Action or ID not found'}, 400);

  } catch (err) {
    return createResponse({success: false, message: err.toString()}, 500);
  }
}

/**
 * HANDLE FILES: Scans for Base64 and saves to Google Drive
 */
function handleFiles(itemData, tabName) {
  let folder;
  const folders = DriveApp.getFoldersByName(FOLDER_NAME);
  if (folders.hasNext()) {
    folder = folders.next();
  } else {
    folder = DriveApp.createFolder(FOLDER_NAME);
  }

  for (let key in itemData) {
    let value = itemData[key];
    if (typeof value === 'string' && value.startsWith('data:') && value.includes('base64,')) {
      try {
        const parts = value.split('base64,');
        const contentType = parts[0].split(':')[1].split(';')[0];
        const decodedData = Utilities.base64Decode(parts[1]);
        
        const ext = contentType.split('/')[1] || 'file';
        const fileName = `${tabName}_${key}_${new Date().getTime()}.${ext}`;
        
        const blob = Utilities.newBlob(decodedData, contentType, fileName);
        const file = folder.createFile(blob);
        file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
        
        // Ganti Base64 dengan URL
        itemData[key] = file.getUrl();
      } catch (e) {
        console.error("File Error: " + e.toString());
      }
    }
  }
  return itemData;
}

function createResponse(data, code = 200) {
  return ContentService.createTextOutput(JSON.stringify(data)).setMimeType(ContentService.MimeType.JSON);
}
